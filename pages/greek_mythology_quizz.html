<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
		<title>Greek mythology quizz</title>
	</head>
<body>
<h2>greek mythology quizz</h2>

<section>
</section>
<input type="text" id="textInput">
<button type="submit" id="click">submit</button>

<p id="yesNo"></p>

<img src="" id="image" height="200">
<p id="para"></p>
<a href="" id="wikipedia_link"></a>

<script>
		const section = document.querySelector('section');
		var dataURL = 'greek_myth_data.json';
		var score = 0;
		var button = document.getElementById("click");
		var yesOrNo = document.getElementById("yesNo");
		// makes variables that are used by the Wikipedia section
		var link = document.getElementById('wikipedia_link');
		var image = document.getElementById("image")
		var wikipediaPara = document.getElementById("para")
		var numberOfQues = 20;
		var characters = null

		function randomNumFunc(maxi) {
			return Math.floor(Math.random() * maxi);
		}

		var firebaseConfig = {
			apiKey: "AIzaSyBtHi0U_Itn8ahgO31UeuibqB8wQohXZak",
			authDomain: "data-char.firebaseapp.com",
			databaseURL: "https://data-char-default-rtdb.firebaseio.com",
			projectId: "data-char",
			storageBucket: "data-char.appspot.com",
			messagingSenderId: "28173089236",
			appId: "1:28173089236:web:dfa7a2c6911310ff37be41"
		};
		firebase.initializeApp(firebaseConfig);

		var database = firebase.database();
		var ref = database.ref('characters')
		ref.on('value', gotData, errData)

		function gotData(data) {
			populateSection(data.val())
		}

		function errData(err) {
			console.error(err)
		}

		function populateSection(jsonObj) {
			var questions = 0;
			var randomCharacter = randomNumFunc(jsonObj.length);
			var character = Object.getOwnPropertyNames(jsonObj[randomCharacter])
			var randomRelation = character[randomNumFunc(character.length)];

			if(randomRelation === "name" || randomRelation === "wikipage") {
				while(randomRelation === "name" || randomRelation === "wikipage") {
					randomRelation = character[randomNumFunc(character.length)];
				}
			}

			var answer = jsonObj[randomCharacter][randomRelation];
			var myPara = document.createElement('p');
			myPara.textContent = "Who is the " + randomRelation + " of " + jsonObj[randomCharacter].name[0] + "?";
			section.appendChild(myPara);
			var oldRelation = randomRelation
			function myFunc() {
				// creates a function to get the summary of the Wikipedia page corresponding to the answer.
				async function wikipedia() {
					for (let i = 0; i < jsonObj.length; i++) {
						if (jsonObj[i].name == answer[0]) {
							var wikipage = jsonObj[i].wikipage;
						}
					}
					if (wikipage === "") {
						var wikipage = "greek_mythology";
					}
					// changes the url of element with the id "wikipedia_link" to a link to the Wikipedia page
					link.href = "https://en.wikipedia.org/wiki/" + wikipage;
					link.textContent = "learn more about " + answer[0] + " on Wikipedia";
					// defines a variable for refering to the URL of the JSON file of the Wikipedia page.
				let url = "https://en.wikipedia.org/api/rest_v1/page/summary/" + wikipage;
					let response = await fetch(url);
					let json = await response.json();
					// changes the paragraph with the id "para" to the first paragraph on the Wikipedia page
					wikipediaPara.innerHTML = json.extract_html;
					// changes the <img> to the first image from the Wikipedia page
					image.src = json.thumbnail.source;
				}
			// calls the function we just created
			wikipedia()
				.catch(error => {
					console.log("error!!!")
					console.error(error)
				});
			questions ++
			var txtBox = document.getElementById("textInput").value;
			// makes the answer case insensitive by turning the answer array to a string then putting it to lower case and then
			// putting it back to an array so the if function can read it
			var caseInsensitiveAnswer = answer.toString().toLowerCase().split(',');
			if(caseInsensitiveAnswer.includes(txtBox.toLowerCase())) {
					score ++;
					yesOrNo.innerHTML = "Bravo!<br>Your score is: " + score + "/" + questions;
				} else if(questions < numberOfQues) {
					yesOrNo.innerHTML = "The " + oldRelation + " of " + jsonObj[randomCharacter].name[0] + " is " + answer[0] + ". Try again. <br> Your score is: " + score + "/" + questions;
				} else {
					yesOrNo.innerHTML = "";
					// clears the image
					image.src = "";
					// clears the paragraph
					wikipediaPara.textContent = "";
					// sets the link to nothing
					link.textContent = ""
				}
				document.getElementById("textInput").value = '';
				document.getElementById("textInput").focus();

				if(questions < numberOfQues){
					randomCharacter = randomNumFunc(jsonObj.length);
					character = Object.getOwnPropertyNames(jsonObj[randomCharacter]);
					randomRelation = character[randomNumFunc(character.length)];
					if(randomRelation === "name" || randomRelation === "wikipage") {
						while(randomRelation === "name" || randomRelation === "wikipage") {
							var randomRelation = character[randomNumFunc(character.length)];
						}
					}
					oldRelation = randomRelation
					answer = jsonObj[randomCharacter][randomRelation];

					oldPara = document.querySelector('p');
					var myPara = document.createElement('p');
					myPara.textContent = "Who is the " + randomRelation + " of " + jsonObj[randomCharacter].name[0] + "?";
				}
				else {
					oldPara = document.querySelector('p');
					var myPara = document.createElement('p');
					myPara.textContent = "You finished! You did " + score + " on " + numberOfQues;
				}
				section.replaceChild(myPara, oldPara);
				}
				input = document.getElementById("textInput");
				input.addEventListener("keyup", function(event) {
					if (event.keyCode === 13) {
						event.preventDefault();
					document.getElementById("click").click();
					}
				});
			button.addEventListener("click", myFunc);
		}

		</script>
</body>
</html>
